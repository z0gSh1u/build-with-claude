# 05f - BM25 语义搜索

在构建 RAG 管道时，你会很快发现仅靠语义搜索并不总是能获得最佳结果。有时你需要精确的术语匹配，而语义搜索可能会遗漏这些匹配。解决方法是使用一种称为 BM25 的技术，将语义搜索与词法搜索结合起来。

![img](./05f-bm25-lexical-search.assets/1.jpg)

## 仅使用语义搜索的问题

假设你在文档中搜索一个特定的案例 ID，如"INC-2023-Q4-011"。虽然语义搜索擅长理解上下文和含义，但它可能会返回与语义相关但实际不包含你所查找的确切术语的段落。

在上面的例子中，语义搜索返回了网络安全部分（这部分确实包含事件 ID），但也返回了完全不提该事件的经济分析部分。这是因为语义搜索关注的是概念相似性，而不是精确的词语匹配。

## 混合搜索策略

解决方案是并行运行语义搜索和词法搜索，然后将结果合并。这样你就能得到两者的最佳效果：

- 语义搜索通过嵌入找到概念上相关的内容
- 词法搜索使用经典文本搜索查找确切的术语匹配
- 合并结果结合了两种方法，以提高准确性

## BM25 搜索

![img](./05f-bm25-lexical-search.assets/2.jpg)

BM25（最佳匹配 25）是一种在 RAG 系统中常用的词法搜索算法。以下是它处理搜索查询的方式：

- **步骤 1：对查询进行分词**

  将用户问题拆分为单个术语。例如，"a INC-2023-Q4-011" 变为 ["a", "INC-2023-Q4-011"]。

- **步骤 2：统计术语频率**

  查看每个术语在所有文档中出现的频率。常见词如 "a" 可能出现 5 次，而特定术语如 "INC-2023-Q4-011" 可能只出现一次。

- **步骤 3：按重要性对术语进行加权**

  出现频率较低的词语会获得更高的重要性分数。"a"这个词因为很常见，所以重要性较低，而"INC-2023-Q4-011"因为罕见，所以重要性较高。

- **步骤 4：查找最佳匹配**

  返回包含更多高权重术语实例的文档。

这里是如何设置一个基本的 BM25 搜索系统：

```python
# 1. Chunk your text by sections
chunks = chunk_by_section(text)

# 2. Create a BM25 store and add documents
store = BM25Index()
for chunk in chunks:
    store.add_document({"content": chunk})

# 3. Search the store
results = store.search("What happened with INC-2023-Q4-011?", 3)

# Print results
for doc, distance in results:
    print(distance, "\n", doc["content"][:200], "\n----\n")
```

当你运行这个搜索时，你会比单独使用语义搜索得到更好的结果。BM25 算法优先考虑实际包含你特定搜索词的段落，尤其是像事件 ID 这样的罕见词。

![img](./05f-bm25-lexical-search.assets/3.jpg)

注意现在结果如何正确地优先考虑软件工程部分和网络安全部分——这两个部分实际上都包含你正在搜索的事件 ID。

## 为什么这个效果更好

BM25 擅长查找精确匹配，因为它：

- 给予稀有、特定术语更高的权重
- 忽略不增加搜索价值的常用词
- 关注词频而非语义意义
- 特别适用于技术术语、ID 和特定短语

关键在于这两种搜索方法都具有互补的优势。语义搜索理解上下文和含义，而词法搜索确保你不会错过确切的术语匹配。通过将它们结合，你就能创建一个更强大的搜索系统，能够有效地处理概念查询和具体查找。在下一步中，你将学习如何合并两个搜索系统的结果，以创建一个统一的混合搜索体验。
